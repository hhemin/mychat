<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- è®¾ç½®ä¸»å±å¹•å›¾æ ‡ -->
  <!--ioså’ŒAndroidéƒ½æ”¯æŒ-->
  <link rel="apple-touch-icon-precomposed" href="./logo.png">
  <!--ä»…Androidæ”¯æŒ-->
  <link rel="icon" href="./logo.png">
  <!-- WebAppæ¨¡å¼ -->
  <!--ioså’ŒAndroidéƒ½æ”¯æŒ-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!--ä»…Androidæ”¯æŒ-->
  <meta name="mobile-web-app-capable" content="yes">

  <!-- ç³»ç»Ÿé¡¶æ çš„é¢œè‰²(content = blackã€white å’Œ black-translucent)é€‰å…¶ä¸€å°±å¯ä»¥ -->
  <meta name="apple-mobile-web-app-status-bar-style" content="white">

  <link rel="icon" href="./logo.png" sizes="32x32">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>hmèŠå¤©</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      text-align: center;
      line-height: 50px;
      font-size: 20px;
      background-color: #03a9f4;
      color: #ffffff;
      z-index: 100;

    }

    .content {
      margin: 50px 0 121px;
      padding: 10px;
    }

    .inpull {
      width: 100%;
      height: 60px;
      position: fixed;
      bottom: 50px;
      box-shadow: 2px -7px 8px 0px #e6e6e6;
      padding: 5px;
      outline: none;
      overflow: auto;
      border-bottom: 1px solid #e4e4e4;
      color: #333333;
    }

    .inpull input {
      outline: none;
      width: 100%;
      height: 100%;
      font-size: 15px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      display: flex;
      /* box-shadow: 1px 1px 9px 2px #888888 */
    }

    footer>div {
      text-align: center;
      line-height: 50px;
      flex: 1;
    }

    footer>div:active {
      background-color: #e6e6e6;
    }

    /* js */
    .fullmain {
      height: 100vh;
      width: 100%;
      line-height: 100vh;
      text-align: center;
    }

    .itemwarp {
      display: flex;
      justify-content: flex-end;
    }

    .itemwarp .my {
      width: 50px;
      height: 50px;
      font-size: 40px;
      border: 2px solid #03a9f4;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      transform: translate(0, 15px);
    }

    .itemwarp .info {
      flex: 1;
      margin-left: 5px;
      padding: 5px;
      /* background-color: green; */
    }

    .itemwarp .info span {
      color: black;
      font-size: 10px;
      transform: translate(0, -15px);
    }

    .itemwarp .info .main {
      display: flex;
      align-items: center;
      display: flex;
      align-items: center;
      background-color: #8BC34A;
      padding: 10px;
      color: #fff;
      text-align: justify;
      word-break: break-all;
    }

    /* ä¸ªäºº */
    .itemwarp.my .info,
    .itemwarp.my .info .main {
      text-align: right;
    }
  </style>
</head>

<body>
  <header onclick="clearip()">
    HM èŠå¤©å®¤å†…ï½ ç‚¹æˆ‘é‡ç½®ä¸ªäºº
  </header>
  <audio src="./mp3/iphone.mp3" id="mp3" style="display: none;">
    <source src="./mp3/iphone.mp3">
    </source>
    ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒï½
  </audio>
  <div class="content" id="content">
    <span id="nei"></span>
    <!-- å…¶ä»–äºº -->
    <!-- <div class="itemwarp">
      <div class="my"></div>
      <div class="info">
        <span>name:231 <time>2008-11-10</time></span>
        <div class="main">
          hhh
        </div>
      </div>
    </div> -->
    <!-- ä¸ªäºº -->
    <!-- <div class="itemwarp my">
      <div class="info">
        <span>name:231 <time>2008-11-10</time></span>
        <div class="main">
          hhh
        </div>
      </div>
      <div class="my"></div>
    </div> -->
  </div>
  <div class="inpull" contenteditable="true" id="inpull" style="background-color: #ffffff;">
  </div>
  <footer id="footer" style="background-color: #ffffff;">
    <div id="pullinfo">å‘é€æ¶ˆæ¯</div>
    <!-- <div id="clearinfo">æ¸…ç©ºä¿¡æ¯</div> -->
  </footer>
  <script type="text/javascript">
    let ws;
    // dom æ“ä½œç±»
    class Dom {
      // æ’­æ”¾
      PlayMp3() {
        document.getElementById('mp3').play();
      };
      // å…¨å±å¹•é«˜åº¦
      fullScreen(word) {
        let main = this.getId('content');
        main.innerHTML = `
          <div class="fullmain">
            ${word}
          </div>
        `
        main.style.margin = 0;
        main.style.padding = 0;
      };
      // è®©ä¹…ä¿¡æ¯å¾€ä¸Šæ»šåŠ¨
      setHeight() {
        let domheigth = document.body.scrollHeight;
        let fooderheight = 121;
        window.scrollBy(0, domheigth + fooderheight);
      };
      // è·å–id
      getId(value) {
        return document.getElementById(value)
      };
    }
    const GetDom = new Dom();
    // æ¸…é™¤
    function clearip() {
      localStorage.removeItem('ip');
      alert('æ¸…ç©ºip')
    }
    // åŠ è½½
    if (window.WebSocket) {
      webinfo();// é“¾æ¥websocket
      let footer = GetDom.getId('footer')
      footer.addEventListener('click', () => {
        footinfo(event);
      })
    } else {
      GetDom.fullScreen('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒwebsocket');
    }

    // å†™æ³•1ã€footeräº‹ä»¶è§¦å‘ (è¿ç”¨äº‹ä»¶å§”æ‰˜)
    class Footeven {
      // å‘é€äº‹ä»¶
      pullinfo() {
        if (ws.readyState == WebSocket.OPEN) {
          ws.send(GetDom.getId('inpull').innerText);
          GetDom.getId('inpull').innerHTML = ''
        }
      };
      // æ¸…ç©ºä¿¡æ¯äº‹ä»¶
      clearinfo() {
        console.log('æ¸…ç©ºä¿¡æ¯');
      };
    }
    // å›è½¦å‘é€
    GetDom.getId('inpull').onkeydown = function (e) {
      // å…¼å®¹FFå’ŒIEå’ŒOpera
      let theEvent = window.event || e;
      let code = theEvent.keyCode || theEvent.which || theEvent.charCode;
      if (code == 13) {
        let _fn_ = new Footeven();
        _fn_['pullinfo']();
        // this.moveEnd('character',-1);
        // console.log
      }
      // console.log(document.selection)
    }
    // function downpull(event) {
    //   event.preventDefault();
    //   let _fn_ = new Footeven();
    //   _fn_['pullinfo'];
    // }
    // å‘é€ä¿¡æ¯
    function footinfo(event) {
      let ev = event || window.event;// å†™å…¼å®¹
      let target = ev.target || target.srcElement;// å†™å…¼å®¹
      if (target.id) {
        let _fn_ = new Footeven();
        const domeven = {
          'pullinfo': () => { _fn_.pullinfo() },
          'clearinfo': () => { _fn_.clearinfo() },
          'default': () => { throw new Error('æ²¡æœ‰è¿™ä¸ªæ–¹æ³•å•Š') }
        }
        domeven[target.id || 'default']();// è°ƒç”¨æ–¹æ³•
      } else {
        throw new Error('å†™ç»‘å®šäº‹ä»¶idå“‡')
      }
    }

    // å»ºç«‹websocket
    function webinfo() {
      // å¦‚æœå¼€å¯æœ¬åœ°å°±æŠŠ101.37.39.177:8080 æ›¿æ¢ä¸ºlocalhost:8080
      // ws = new WebSocket("ws://101.37.39.177:8080//ws");
      ws = new WebSocket("ws://192.168.1.7:8081")
      let N = GetDom.getId('nei');
      // è¿æ¥å»ºç«‹æ—¶è§¦å‘
      ws.onopen = function (e) {
        // Web Socket å·²è¿æ¥ä¸Šï¼Œä½¿ç”¨ send() æ–¹æ³•å‘é€æ•°æ®
        // ws.send("å‘é€æ•°æ®");
        N.innerHTML = "è¿æ¥å¼€å¯"
      };
      // å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯æ•°æ®æ—¶è§¦å‘
      ws.onmessage = function (e) {
        let _box = GetDom.getId('content');
        let getdata = e.data.split('ip,');
        let getip = getdata[0];// ip
        let main = getdata[1] || '';// å†…å®¹
        // let _who = 'my';
        console.log(getip + ' ' + main);
        if (!localStorage.getItem('ip')) {
          // åˆå§‹åŒ–;
          localStorage.setItem('ip', getip)
        }
        if (main == "") return;// å¦‚æœå†…å®¹ä¸ºç©ºä¸‹é¢åœæ­¢å³è¡Œ
        if (localStorage.getItem('ip') === getip) {
          // è‡ªå·±
          let dom = document.createElement('div');
          dom.setAttribute('class', 'itemwarp my');
          dom.innerHTML = `
              <div class="info">
                <span>name:${getip} <time></time></span>
                <div class="main">
                  ${main}
                </div>
              </div>
              <div class="my">ğŸ˜¯</div>
           `
          _box.appendChild(dom);
          GetDom.setHeight();
        } else {
          GetDom.PlayMp3();
          // ä»–äºº
          let dom = document.createElement('div');
          dom.setAttribute('class', 'itemwarp');
          dom.innerHTML = `
            <div class="my">ğŸ°</div>
            <div class="info">
              <span>name:${getip} <time></time></span>
              <div class="main">
                ${main}
              </div>
            </div>
          `
          _box.appendChild(dom);
          GetDom.setHeight();
        }
      }
      // è¿æ¥å…³é—­æ—¶è§¦å‘
      ws.onclose = function (e) {
        console.log(e)
        N.innerHTML = 'è¿æ¥è¢«å…³é—­' + 'websocket æ–­å¼€: ' + e.code + ' ' + e.reason + ' ' + e.wasClean
      };
    }
  </script>
</body>

</html>